? my $channels = $_[0]->{channels};
? my $nick = $_[0]->{nick};
<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0;" />
        <title>IRC Chat</title>
        <link rel="stylesheet" href="/static/screen.css" />
        <link rel="stylesheet" href="/static/application.css" />
    </head>
    <body>
        <form id="irc">
            <div>
                <input id="ident" type="hidden" name="ident" value="<?= $nick ?>" />
                <input id="channel" type="text" name="channel" readonly="readonly" />
                <label for="text">Say:</label>
                <input id="text" name="text" type="text"/>
            </div>
        </form>

        <ul id="channels">
    <? foreach my $name (map { my $o = $_; $_ = lc($_); s/([^0-9a-z])/ord($1)/eg; [$_, $o]; } @$channels) { ?>
            <li><a href="/irc#channel-<?= $name->[0] ?>"><?= $name->[1] ?></a></li>
            <? } ?>
        </ul>

        <div id="footer">Powered by <a href="http://github.com/miyagawa/Tatsumaki">Tatsumaki/<?= $Tatsumaki::VERSION ?></a>.</div>

        <script src="/static/jquery-1.3.2.min.js"></script>
? if ($_[0]->{handler}->request->param('mxhr')) {
        <script src="/static/DUI.js"></script>
        <script src="/static/Stream.js"></script>
? } else {
        <script src="/static/jquery.ev.js"></script>
? }
        <script src="/static/jquery.md5.js"></script>
        <script src="/static/jquery.oembed.js"></script>
        <script type="text/javascript" src="/static/application.js"></script>
        <script type="text/javascript">
$(function(){
    $("#text").focus();

    var onNewEvent = function(e) {
        try {
            var src    = e.avatar || ("http://www.gravatar.com/avatar/" + $.md5(e.ident || 'foo'));
            var name   = e.name   || e.ident || 'Anonymous';
            var avatar = $('<img/>').attr('src', src).attr('alt', name);

            if (e.ident) {
                var link = e.ident.match(/https?:/) ? e.ident : 'mailto:' + e.ident;
                avatar = $('<a/>').attr('href', link).attr('target', '_blank').append(avatar);
            }
            avatar = $('<div/>').addClass('avatar').append(avatar);

            var message = $('<div/>').addClass('chat-message');
            if (e.text) message.text(e.text);
            if (e.html) message.html(e.html);
            message.find('a').oembed(null, { embedMethod: "append", maxWidth: 320 });
            var name = e.name || (e.ident ? e.ident.split('@')[0] : null);
            if (name)
                message.prepend($('<span/>').addClass('name').text(name+ ': '));

            var meta = $('<span/>').addClass('meta').text(' (' + e.time + ' from ' + e.address + ')');

            var channel_el_id = "channel-" + e.channel.toLowerCase().replace(/[^0-9a-z]/g, function(s) { return s.toString().charCodeAt(0) });

            if ($("#" + channel_el_id).size() == 0) {
                $("<div/>").insertAfter("#channels").attr({ "id": channel_el_id, "class": "channel" }).html("<ul class='messages'></ul>");
            }

            $('.messages', "#" + channel_el_id).prepend($('<li/>').addClass('message').addClass("clearfix").append(avatar).append(message).append(meta));
        } catch(e) { if (console) console.log(e) };
    }

    if (typeof DUI != 'undefined') {
        var s = new DUI.Stream();
        s.listen('application/json', function(payload) {
            var event = eval('(' + payload + ')');
            onNewEvent(event);
        });
        s.load('/irc/mpoll?session=' + Date.now() + Math.random());
    } else {
        $.ev.handlers.message = onNewEvent;
        $.ev.loop('/irc/poll?session=' + Date.now() + Math.random());
    }

    $("form#irc").bind("submit", function() {
        var ident = $("#ident").val();
        var text = $("#text").val();
        var channel = $("#channel").val();

        if (!text || !ident || !channel) return false;

        $.ajax({
            url: "/irc",
            data: $(this).serialize(),
            type: 'post',
            dataType: 'json',
            success: function(r) { $("#text").val("").focus(); }
        });
        return false;
    });
});
</script>
    </body>
</html>
